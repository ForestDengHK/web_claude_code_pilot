name: Build & Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build Next.js standalone app
        run: npm run build

      - name: Get version and previous tag
        id: meta
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          PREV_TAG=$(git tag --sort=-creatordate | grep '^v' | sed -n '2p' || echo "")
          echo "prev_tag=$PREV_TAG" >> "$GITHUB_OUTPUT"

      - name: Generate changelog
        id: changelog
        run: |
          PREV_TAG="${{ steps.meta.outputs.prev_tag }}"
          if [ -n "$PREV_TAG" ]; then
            RANGE="${PREV_TAG}..HEAD"
          else
            RANGE="HEAD"
          fi
          {
            echo "changelog<<CHANGELOG_EOF"
            git log "$RANGE" --pretty=format:'| `%h` | %s |'
            echo ""
            echo "CHANGELOG_EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.meta.outputs.version }}"
          PREV_TAG="${{ steps.meta.outputs.prev_tag }}"

          cat > release-notes.md << 'NOTES_EOF'
          ## Deployment

          This is a self-hosted web application. Pull the latest tag and run:

          ```bash
          npm ci && npm run build && npm run start
          ```

          ## Requirements

          - Node.js 20+
          - Anthropic API Key or `ANTHROPIC_API_KEY` environment variable

          ## Changelog
          NOTES_EOF

          if [ -n "$PREV_TAG" ]; then
            echo "" >> release-notes.md
            echo "| Commit | Description |" >> release-notes.md
            echo "|--------|-------------|" >> release-notes.md
            cat >> release-notes.md << 'CHANGELOG_INLINE_EOF'
          ${{ steps.changelog.outputs.changelog }}
          CHANGELOG_INLINE_EOF
          fi

          gh release create "${GITHUB_REF_NAME}" \
            --title "Web Claude Code Pilot v${VERSION}" \
            --notes-file release-notes.md \
            --latest
